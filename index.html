<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Control Aeropuerto ‚Äì Sura</title>
<style>
  :root{
    --bg:#ffffff; --muted:#f5f7fb; --text:#111; --sub:#6b7280; --line:#e5e7eb;
    --primary:#2563eb; --primary-600:#1d4ed8; --radius:14px;
    --fs:14px; --row-h:48px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;font-size:var(--fs)}
  .container{max-width:1200px;margin:0 auto;padding:16px 16px 80px;}

  .topbar{position:sticky; top:0; z-index:30; background:var(--bg); padding:12px 0 10px; border-bottom:1px solid var(--line)}
  .topline{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  h1{font-size:22px;margin:0 12px 0 0;}
  .chip{background:#eef2ff;border:1px solid #e0e7ff;color:#1e3a8a;padding:6px 10px;border-radius:999px;font-size:12px;white-space:nowrap}
  .toolbar{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .search{flex:1 1 260px;min-width:220px}

  input[type="text"], input[type="date"], textarea, select{
    width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px;outline:none
  }
  .btn{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .btn.primary:hover{background:var(--primary-600)}
  .btn.danger{background:#fee2e2;color:#991b1b;border-color:#fecaca}
  .btn.icon{display:inline-flex;gap:8px;align-items:center}
  .hidden{display:none}

  .table-wrap{margin-top:10px;overflow:auto;border:1px solid var(--line);border-radius:12px;max-height:70vh;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:1000px}
  thead th{position:sticky; top:0; z-index:10; background:#e3f2ff; color:#0f172a; text-align:left; font-weight:700; padding:10px; border-bottom:1px solid var(--line)}
  tbody td{padding:10px;border-bottom:1px solid var(--line);height:var(--row-h);white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
  tbody tr:hover{background:var(--muted)}
  .zebra tbody tr:nth-child(odd){background:#fafcff}
  .wrap tbody td{white-space:normal}
  .hidden-row{display:none !important}

  .col-idx{width:48px;text-align:right;color:var(--sub)}
  .row-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn.small{padding:6px 10px;border-radius:10px;font-weight:600}
  .note-input{min-width:160px}
  .passport{min-width:130px}
  .check{width:18px;height:18px}

  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;font-size:12px;font-weight:700}
  .pill.green{color:#065f46;border-color:#d1fae5;background:#ecfdf5}
  .pill.yellow{color:#92400e;border-color:#fef3c7;background:#fffbeb}
  .pill.red{color:#991b1b;border-color:#fee2e2;background:#fef2f2}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(680px,95vw);background:#fff;border-radius:16px;padding:18px;border:1px solid var(--line)}
  .modal h2{margin:0 0 12px 0}
  .grid{display:grid;gap:10px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  @media (max-width:640px){ .grid.cols-2{grid-template-columns:1fr} }
  .modal .footer{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}

  /* Columnas fijas */
  .sticky-left{position:sticky; left:0; z-index:15; background:#fff; box-shadow:1px 0 0 0 var(--line)}
  thead .sticky-left{background:#e3f2ff; z-index:20}

  /* Popover Vista */
  .popover{position:absolute; background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.08); display:none; z-index:40; min-width:220px}
  .popover .item{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:8px;cursor:pointer}
  .popover .item:hover{background:#f8fafc}
  .sep{height:1px;background:var(--line);margin:6px 0}
  .row{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .muted{color:var(--sub);font-size:12px}

  @media print{
    .topbar .btn, .row-actions .btn, .row-actions .note-input, .row-actions .passport, .row-actions .check, .row-actions select{ display:none !important }
    .table-wrap{border:none}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="topline">
        <h1>Control Aeropuerto</h1>
        <span class="chip">Empresa: Sura</span>
        <span class="chip">Vuelo de Ida: AM 0668 ¬∑ MEX‚ÄìSFO ¬∑ 08:55‚Äì11:55 ¬∑ 03/11/2025</span>
        <span class="chip">Regreso: AM 0665 ¬∑ SFO‚ÄìMEX ¬∑ 07/11/2025</span>
        <span class="chip" id="chip-count">0 pasajer@/s</span>
      </div>
      <div class="toolbar">
        <div class="search"><input id="q" type="text" placeholder="Buscar (nombre, apellidos, vuelo, clave, origen, etc.)"></div>
        <select id="f-semaforo"><option value="">Sem√°foro (todos)</option><option>VERDE</option><option>AMARILLO</option><option>ROJO</option></select>
        <select id="f-asist"><option value="">Asistencia (todos)</option><option value="true">Con asistencia</option><option value="false">Sin asistencia</option></select>
        <select id="f-migr"><option value="">Migraci√≥n (todos)</option><option value="true">Con migraci√≥n</option><option value="false">Sin migraci√≥n</option></select>

        <input id="csv-file" type="file" accept=".csv" class="hidden">
        <button class="btn icon" id="btn-import">üì• Importar CSV</button>
        <button class="btn icon" id="btn-export">üì§ Exportar CSV</button>
        <button class="btn icon" id="btn-print">üñ®Ô∏è Imprimir</button>
        <button class="btn icon" id="btn-freeze">üìå Fijar columnas</button>
        <button class="btn primary icon" id="btn-view">üéö Vista</button>
        <button class="btn primary icon" id="btn-add">Ôºã Agregar pasajero</button>
      </div>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table id="tabla">
        <thead>
          <tr>
            <th class="col-idx">#</th>
            <th>Primer Nombre</th>
            <th>Fecha NCTO</th>
            <th>ORIGEN</th>
            <th>FECHA</th>
            <th>VUELO</th>
            <th>ORIG DSTN</th>
            <th>SALE-LLEGA</th>
            <th>CLAVE</th>
            <th>N¬∞ pasaporte</th>
            <th>Asist.</th>
            <th>Migr.</th>
            <th>Sem√°foro</th>
            <th>Notas</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal CRUD -->
  <div class="modal-backdrop" id="modal-bd">
    <div class="modal">
      <h2 id="modal-title">Agregar pasajero</h2>
      <div class="grid cols-2">
        <div><label>Primer nombre<input id="m-nombre" type="text" placeholder="Ej. Griselda Elizabeth Garcia Garza"></label></div>
        <div><label>Fecha NCTO<input id="m-ncto" type="date"></label></div>
        <div><label>Origen<input id="m-origen" type="text" placeholder="MEX"></label></div>
        <div><label>Fecha<input id="m-fecha" type="date"></label></div>
        <div><label>Vuelo<input id="m-vuelo" type="text" placeholder="AM 0668"></label></div>
        <div><label>Orig Dstn<input id="m-od" type="text" placeholder="MEX‚ÄìSFO"></label></div>
        <div><label>Sale-Llega<input id="m-hora" type="text" placeholder="08:55‚Äì11:55"></label></div>
        <div><label>Clave<input id="m-clave" type="text" placeholder="HKHGVG/NFIY6Q"></label></div>
        <div><label>N¬∞ pasaporte<input id="m-pass" type="text"></label></div>
        <div><label>Sem√°foro
          <select id="m-sema"><option>VERDE</option><option>AMARILLO</option><option>ROJO</option></select>
        </label></div>
        <div style="display:flex;gap:14px;align-items:center;margin-top:6px">
          <label><input id="m-asist" type="checkbox" class="check"> Asistencia</label>
          <label><input id="m-migr" type="checkbox" class="check"> Migraci√≥n</label>
        </div>
        <div class="colspan" style="grid-column:1/-1"><label>Notas<textarea id="m-notas" rows="2" placeholder="Observaciones"></textarea></label></div>
      </div>
      <div class="footer"><button class="btn" id="m-cancel">Cancelar</button><button class="btn primary" id="m-save">Guardar</button></div>
    </div>
  </div>

  <!-- Modal Fijar columnas -->
  <div class="modal-backdrop" id="freeze-bd">
    <div class="modal">
      <h2>Fijar columnas</h2>
      <div class="grid cols-2" id="freeze-list"></div>
      <div class="footer">
        <button class="btn" id="freeze-cancel">Cancelar</button>
        <button class="btn primary" id="freeze-apply">Aplicar</button>
      </div>
    </div>
  </div>

  <!-- Popover Vista -->
  <div class="popover" id="view-pop">
    <div class="item" data-density="compacta">Compacta <span class="muted">36px / 13px</span></div>
    <div class="item" data-density="media">Media <span class="muted">48px / 14px</span></div>
    <div class="item" data-density="amplia">Amplia <span class="muted">60px / 15px</span></div>
    <div class="sep"></div>
    <label class="row"><span>Filas zebra</span><input type="checkbox" id="opt-zebra"></label>
    <label class="row"><span>Envolver texto</span><input type="checkbox" id="opt-wrap"></label>
  </div>

<script>
(() => {
  // === Keys
  const KEY='controlAeropuerto.v1', FREEZE_KEY='controlAeropuerto.freezeCols', VIEW_KEY='controlAeropuerto.view', FREEZE_W_KEY='controlAeropuerto.freezeWidths';

  // === Utils
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const norm=s=>(s??'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[.,]/g,' ').toLowerCase().trim();
  const esc=s=>(s??'').toString().replace(/[<>&]/g,m=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]));
  const escAttr=s=>esc(s).replace(/"/g,'&quot;');
  const csvCell=v=>{const s=(v??'').toString().replace(/"/g,'""');return /[",\n]/.test(s)?`"${s}"`:s;};
  const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const load=k=>{ try{return JSON.parse(localStorage.getItem(k)||'null');}catch{return null;} };
  const debounce=(fn,ms)=>{let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);}};

  // === Datos
  let data=load(KEY)||[];
  if(!data||!data.length){
    data=[{"nombre":"Griselda Elizabeth Garcia Garza","ncto":"1989-11-06","origen":"MTY","fecha":"2025-11-03","vuelo":"AM 0668","orig_dstn":"MEX-SFO","sale_llega":"08:55-11:55","clave":"HKHGVG/NFIY6Q","pasaporte":"","asistencia":false,"migracion":false,"semaforo":"VERDE","notas":""},{"nombre":"Luis Gerardo Cisneros Gonzalez","ncto":"1977-03-17","origen":"MTY","fecha":"2025-11-03","vuelo":"AM 0668","orig_dstn":"MEX-SFO","sale_llega":"08:55-11:55","clave":"HKHGVG/NFIY6Q","pasaporte":"","asistencia":false,"migracion":false,"semaforo":"VERDE","notas":""},{"nombre":"Margarita Velez Escamilla","ncto":"1975-10-16","origen":"MTY","fecha":"2025-11-03","vuelo":"AM 0668","orig_dstn":"MEX-SFO","sale_llega":"08:55-11:55","clave":"HKHGVG/NFIY6Q","pasaporte":"","asistencia":false,"migracion":false,"semaforo":"VERDE","notas":""},{"nombre":"Tania Lizeth Aleman Castillo","ncto":"1991-10-05","origen":"MTY","fecha":"2025-11-03","vuelo":"AM 0668","orig_dstn":"MEX-SFO","sale_llega":"08:55-11:55","clave":"HKHGVG/NFIY6Q","pasaporte":"","asistencia":false,"migracion":false,"semaforo":"VERDE","notas":""},{"nombre":"Norma Amelia Gonzalez Garza","ncto":"1972-05-03","origen":"MTY","fecha":"2025-11-03","vuelo":"AM 0668","orig_dstn":"MEX-SFO","sale_llega":"08:55-11:55","clave":"SPLHZP/NFIY6Q","pasaporte":"","asistencia":false,"migracion":false,"semaforo":"VERDE","notas":""},{"nombre":"Elsa Yolanda Guerrero Hernandez","ncto":"1975-06-25","origen":"MTY","fecha":"2025-11-03","vuelo":"AM 0668","orig_dstn":"MEX-SFO","sale_llega":"08:55-11:55","clave":"SPLHZP/NFIY6Q","pasaporte":"","asistencia":false,"migracion":false,"semaforo":"VERDE","notas":""},{"nombre":"Nubia Anahi Cantu Ibarra","ncto":"1994-08-12","origen":"MTY","fecha":"2025-11-03","vuelo":"AM 0668","orig_dstn":"MEX-SFO","sale_llega":"08:55-11:55","clave":"SPLHZP/NFIY6Q","pasaporte":"","asistencia":false,"migracion":false,"semaforo":"VERDE","notas":""},{"nombre":"Luis Manuel Rodriguez Cervantes","ncto":"1995-01-24","origen":"MTY","fecha":"2025-11-03","vuelo":"AM 0668","orig_dstn":"MEX-SFO","sale_llega":"08:55-11:55","clave":"SPLHZP/NFIY6Q","pasaporte":"","asistencia":false,"migracion":false,"semaforo":"VERDE","notas":""},{"nombre":"Yurie Hernandez Soberon","ncto":"1983-11-21","origen":"MTY","fecha":"2025-11-03","vuelo":"AM 0668","orig_dstn":"MEX-SFO","sale_llega":"08:55-11:55","clave":"SPLHZP/NFIY6Q","pasaporte":"","asistencia":false,"migracion":false,"semaforo":"VERDE","notas":""},{"nombre":"Alicia Nayeli Avila","ncto":"1999-07-16","origen":"MTY","fecha":"2025-11-03","vuelo":"AM 0668","orig_dstn":"MEX-SFO","sale_llega":"08:55-11:55","clave":"SPLHZP/NFIY6Q","pasaporte":"","asistencia":false,"migracion":false,"semaforo":"VERDE","notas":""}];
    save(KEY,data);
  }

  // === Columnas meta (para ‚Äúfijar‚Äù)
  const COLS=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]; // √≠ndices

  // === Render inicial (crea filas una vez)
  const tbody=$('#tbody');
  function buildOnce(){
    tbody.innerHTML = data.map((r,i)=>`
      <tr data-idx="${i}">
        <td class="col-idx">${i+1}</td>
        <td>${esc(r.nombre)}</td>
        <td>${esc(r.ncto)}</td>
        <td>${esc(r.origen)}</td>
        <td>${esc(r.fecha)}</td>
        <td>${esc(r.vuelo)}</td>
        <td>${esc(r.orig_dstn)}</td>
        <td>${esc(r.sale_llega)}</td>
        <td>${esc(r.clave)}</td>
        <td><input class="passport" type="text" value="${escAttr(r.pasaporte||'')}" data-field="pasaporte"></td>
        <td><input class="check" type="checkbox" ${r.asistencia?'checked':''} data-field="asistencia"></td>
        <td><input class="check" type="checkbox" ${r.migracion?'checked':''} data-field="migracion"></td>
        <td>
          <select data-field="semaforo">
            ${['VERDE','AMARILLO','ROJO'].map(o=>`<option ${o===(r.semaforo||'VERDE')?'selected':''}>${o}</option>`).join('')}
          </select>
          <span class="pill ${pillClass(r.semaforo)}">${r.semaforo||'VERDE'}</span>
        </td>
        <td><input class="note-input" type="text" value="${escAttr(r.notas||'')}" data-field="notas"></td>
        <td class="row-actions"><button class="btn small" data-act="edit">Editar</button><button class="btn small danger" data-act="del">Eliminar</button></td>
      </tr>`).join('');

    // eventos inline (una vez)
    $$('#tbody input[data-field], #tbody select[data-field]').forEach(el=>{
      el.addEventListener('input', onInlineEdit);
      el.addEventListener('change', onInlineEdit);
    });
    $$('#tbody [data-act="edit"]').forEach(b=>b.addEventListener('click', onEdit));
    $$('#tbody [data-act="del"]').forEach(b=>b.addEventListener('click', onDel));
  }

  function pillClass(v){ v=(v||'VERDE').toUpperCase(); return v==='ROJO'?'red':(v==='AMARILLO'?'yellow':'green'); }

  // === Filtro sin destruir filas
  function applyFilter(){
    const q=norm($('#q').value), fSem=$('#f-semaforo').value, fAs=$('#f-asist').value, fMi=$('#f-migr').value;
    let visibles=0;
    $$('#tbody tr').forEach(tr=>{
      const i=Number(tr.dataset.idx), r=data[i];
      const passSem = !fSem || (r.semaforo||'').toUpperCase()===fSem;
      const passAs  = fAs==='' || String(!!r.asistencia)===fAs;
      const passMi  = fMi==='' || String(!!r.migracion)===fMi;
      const hay = norm([r.nombre,r.ncto,r.origen,r.fecha,r.vuelo,r.orig_dstn,r.sale_llega,r.clave,r.pasaporte,r.notas].join(' '));
      const passQ = !q || hay.includes(q);
      const ok = passSem && passAs && passMi && passQ;
      tr.classList.toggle('hidden-row', !ok);
      if(ok) visibles++;
    });
    $('#chip-count').textContent = `${visibles} pasajer@/s`;
    // re-aplica offsets sin soltar fijado
    stableFreeze();
  }

  // === Inline edit
  function onInlineEdit(e){
    const tr=e.target.closest('tr'); const idx=Number(tr.dataset.idx); const f=e.target.dataset.field;
    if (f==='asistencia'||f==='migracion'){ data[idx][f]=e.target.checked; }
    else if (f==='semaforo'){ data[idx][f]=e.target.value; tr.querySelector('.pill').textContent=e.target.value; tr.querySelector('.pill').className='pill '+pillClass(e.target.value); }
    else { data[idx][f]=e.target.value; }
    save(KEY,data);
  }

  // === CRUD
  let editingIndex=null;
  function openModal(val={}){
    $('#modal-title').textContent=(editingIndex===null)?'Agregar pasajero':'Editar pasajero';
    $('#m-nombre').value=val.nombre||''; $('#m-ncto').value=val.ncto||''; $('#m-origen').value=val.origen||'';
    $('#m-fecha').value=val.fecha||''; $('#m-vuelo').value=val.vuelo||''; $('#m-od').value=val.orig_dstn||'';
    $('#m-hora').value=val.sale_llega||''; $('#m-clave').value=val.clave||''; $('#m-pass').value=val.pasaporte||'';
    $('#m-sema').value=val.semaforo||'VERDE'; $('#m-asist').checked=!!val.asistencia; $('#m-migr').checked=!!val.migracion; $('#m-notas').value=val.notas||'';
    $('#modal-bd').style.display='flex';
  }
  function closeModal(){ $('#modal-bd').style.display='none'; editingIndex=null; }
  function onEdit(e){ const idx=Number(e.target.closest('tr').dataset.idx); editingIndex=idx; openModal(data[idx]); }
  function onDel(e){
    const idx=Number(e.target.closest('tr').dataset.idx);
    if(confirm('¬øEliminar pasajero?')){ data.splice(idx,1); save(KEY,data); buildOnce(); applyFilter(); }
  }
  $('#m-cancel').addEventListener('click', closeModal);
  $('#m-save').addEventListener('click', ()=>{
    const rec = {
      nombre:$('#m-nombre').value.trim(), ncto:$('#m-ncto').value, origen:$('#m-origen').value.trim(),
      fecha:$('#m-fecha').value, vuelo:$('#m-vuelo').value.trim(), orig_dstn:$('#m-od').value.trim(),
      sale_llega:$('#m-hora').value.trim(), clave:$('#m-clave').value.trim(), pasaporte:$('#m-pass').value.trim(),
      asistencia:$('#m-asist').checked, migracion:$('#m-migr').checked, semaforo:$('#m-sema').value, notas:$('#m-notas').value.trim()
    };
    if(!rec.nombre){ alert('El nombre es obligatorio'); return; }
    if(editingIndex===null) data.push(rec); else data[editingIndex]=rec;
    save(KEY,data); buildOnce(); applyFilter(); closeModal();
  });
  $('#modal-bd').addEventListener('click', e=>{ if(e.target.id==='modal-bd') closeModal(); });

  // === CSV
  $('#btn-import').addEventListener('click', ()=>$('#csv-file').click());
  $('#csv-file').addEventListener('change', async e=>{
    const f=e.target.files[0]; if(!f) return; const t=await f.text(); const rows=parseCSV(t); if(!rows.length){ alert('CSV vac√≠o'); return; }
    data=data.concat(mapCSV(rows)); save(KEY,data); buildOnce(); applyFilter(); e.target.value='';
  });
  $('#btn-export').addEventListener('click', ()=>{
    const headers=['primer_nombre','fecha_ncto','origen','fecha','vuelo','orig_dstn','sale_llega','clave','pasaporte','asistencia','migracion','semaforo','notas'];
    const out=[headers.join(',')].concat(data.map(r=>headers.map(h=>csvCell(h==='primer_nombre'?r.nombre:h==='fecha_ncto'?r.ncto:r[h])).join(','))).join('\n');
    const blob=new Blob([out],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='control-aeropuerto.csv'; document.body.appendChild(a); a.click(); a.remove();
  });
  $('#btn-print').addEventListener('click', ()=>window.print());
  $('#btn-add').addEventListener('click', ()=>{ editingIndex=null; openModal({semaforo:'VERDE'}); });

  // === Filtros con debounce
  const debFilter=debounce(applyFilter,150);
  $('#q').addEventListener('input', debFilter);
  $('#f-semaforo').addEventListener('change', applyFilter);
  $('#f-asist').addEventListener('change', applyFilter);
  $('#f-migr').addEventListener('change', applyFilter);

  // === CSV helpers
  function parseCSV(text){
    const lines=text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length), rows=[];
    for(const line of lines){
      const out=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const c=line[i];
        if(c==='\"'){ if(inQ && line[i+1]==='\"'){cur+='\"'; i++;} else inQ=!inQ; }
        else if(c===',' && !inQ){ out.push(cur); cur=''; }
        else cur+=c;
      }
      out.push(cur); rows.push(out);
    }
    return rows;
  }
  function mapCSV(rows){
    const head=rows[0].map(h=>norm(h));
    const idx=name=> head.findIndex(h=>[name,name.replace(/_/g,' ')].some(c=>h.includes(c)));
    const col={ nombre: idx('primer nombre')!==-1?idx('primer nombre'):idx('nombre'),
      ncto: idx('fecha ncto')!==-1?idx('fecha ncto'):idx('ncto'), origen: idx('origen'),
      fecha: idx('fecha'), vuelo: idx('vuelo'),
      orig_dstn: idx('orig dstn')!==-1?idx('orig dstn'):idx('ruta ida'),
      sale_llega: idx('sale llega')!==-1?idx('sale llega'):idx('hora ida'),
      clave: idx('clave'), pasaporte: idx('pasaporte'),
      asistencia: idx('asistencia'), migracion: idx('migracion'),
      semaforo: idx('semaforo'), notas: idx('notas') };
    const out=[];
    for(let r=1;r<rows.length;r++){
      const row=rows[r], val=f=> col[f]>=0?(row[col[f]]??'').toString().trim():'';
      if(!val('nombre')) continue;
      out.push({nombre:val('nombre'), ncto:val('ncto'), origen:val('origen'), fecha:val('fecha'),
        vuelo:val('vuelo'), orig_dstn:val('orig_dstn'), sale_llega:val('sale_llega'), clave:val('clave'),
        pasaporte:val('pasaporte'), asistencia:/true|1|si|s√≠|x/i.test(val('asistencia')),
        migracion:/true|1|si|s√≠|x/i.test(val('migracion')), semaforo:(val('semaforo')||'VERDE').toUpperCase(), notas:val('notas')});
    }
    return out;
  }

  // === Fijar columnas (estable y sin parpadeo)
  const freezeBd=$('#freeze-bd'), freezeList=$('#freeze-list');
  $('#btn-freeze').addEventListener('click', ()=>{
    const sel=new Set(load(FREEZE_KEY)||[]);
    freezeList.innerHTML = COLS.map(i=>`<label style="display:flex;gap:10px;align-items:center"><input type="checkbox" value="${i}" ${sel.has(i)?'checked':''}><span>${$('#tabla thead th:nth-child('+(i+1)+')').textContent||'Col '+i}</span></label>`).join('');
    freezeBd.style.display='flex';
  });
  $('#freeze-cancel').addEventListener('click', ()=> freezeBd.style.display='none');
  $('#freeze-apply').addEventListener('click', ()=>{
    const checked=Array.from(freezeList.querySelectorAll('input:checked')).map(el=>Number(el.value)).sort((a,b)=>a-b);
    save(FREEZE_KEY,checked);
    // congela anchos una sola vez y los recuerda
    const widths = COLS.map(i=> $('#tabla thead th:nth-child('+(i+1)+')').getBoundingClientRect().width );
    save(FREEZE_W_KEY,widths);
    freezeBd.style.display='none';
    stableFreeze(true);
  });

  function stableFreeze(force=false){
    const sel=(load(FREEZE_KEY)||[]).sort((a,b)=>a-b);
    const tw=$('#tableWrap'); const prevScroll=tw.scrollLeft;
    const widths = load(FREEZE_W_KEY) || COLS.map(i=> $('#tabla thead th:nth-child('+(i+1)+')').getBoundingClientRect().width );

    // fija anchos (evita que cambien por la barra de scroll)
    if(force || !load(FREEZE_W_KEY)){
      COLS.forEach((i)=>{
        const th=$('#tabla thead th:nth-child('+(i+1)+')');
        th.style.minWidth = th.style.maxWidth = th.style.width = widths[i]+'px';
        $$('#tabla tbody tr').forEach(tr=>{
          const td=tr.children[i]; if(!td) return;
          td.style.minWidth=td.style.maxWidth=td.style.width=widths[i]+'px';
        });
      });
      save(FREEZE_W_KEY,widths);
    }

    // aplica offsets en doble frame para evitar parpadeo
    $$('#tabla th, #tabla td').forEach(c=>{ c.classList.remove('sticky-left'); c.style.left=null; });
    requestAnimationFrame(()=>{ requestAnimationFrame(()=>{
      let acc=0;
      sel.forEach(idx=>{
        const w=widths[idx];
        const th=$('#tabla thead th:nth-child('+(idx+1)+')');
        th.classList.add('sticky-left'); th.style.left=acc+'px';
        $$('#tabla tbody tr').forEach(tr=>{
          const td=tr.children[idx]; if(!td) return;
          td.classList.add('sticky-left'); td.style.left=acc+'px';
        });
        acc+=w;
      });
      tw.scrollLeft=prevScroll;
    }); });
  }

  // === Vista
  const pop=$('#view-pop'); let popOpen=false;
  $('#btn-view').addEventListener('click', (e)=>{
    const r=e.target.getBoundingClientRect(); pop.style.left=r.left+'px'; pop.style.top=(r.bottom+8)+'px';
    pop.style.display='block'; popOpen=true;
    const st=load(VIEW_KEY)||{}; $('#opt-zebra').checked=!!st.zebra; $('#opt-wrap').checked=!!st.wrap;
  });
  document.addEventListener('click', e=>{ if(popOpen && !pop.contains(e.target) && e.target.id!=='btn-view'){ pop.style.display='none'; popOpen=false; }});
  $$('#view-pop .item[data-density]').forEach(it=>{
    it.addEventListener('click', ()=>{
      const d=it.getAttribute('data-density'); const st=load(VIEW_KEY)||{};
      if(d==='compacta'){ document.documentElement.style.setProperty('--row-h','36px'); document.documentElement.style.setProperty('--fs','13px'); st.d='compacta'; }
      else if(d==='amplia'){ document.documentElement.style.setProperty('--row-h','60px'); document.documentElement.style.setProperty('--fs','15px'); st.d='amplia'; }
      else { document.documentElement.style.setProperty('--row-h','48px'); document.documentElement.style.setProperty('--fs','14px'); st.d='media'; }
      save(VIEW_KEY,st);
    });
  });
  $('#opt-zebra').addEventListener('change', e=>{ const st=load(VIEW_KEY)||{}; st.zebra=e.target.checked; save(VIEW_KEY,st); applyView(); });
  $('#opt-wrap').addEventListener('change', e=>{ const st=load(VIEW_KEY)||{}; st.wrap=e.target.checked; save(VIEW_KEY,st); applyView(); });
  function applyView(){
    const st=load(VIEW_KEY)||{}; const tw=$('#tableWrap');
    if(st.d==='compacta'){ document.documentElement.style.setProperty('--row-h','36px'); document.documentElement.style.setProperty('--fs','13px'); }
    else if(st.d==='amplia'){ document.documentElement.style.setProperty('--row-h','60px'); document.documentElement.style.setProperty('--fs','15px'); }
    else { document.documentElement.style.setProperty('--row-h','48px'); document.documentElement.style.setProperty('--fs','14px'); }
    tw.classList.toggle('zebra', !!st.zebra); tw.classList.toggle('wrap', !!st.wrap);
  }

  // === Inicio
  applyView();
  buildOnce();
  // set total visible al principio
  $('#chip-count').textContent = `${data.length} pasajer@/s`;
  // aplica freeze guardado (si existe)
  stableFreeze(true);

})();
</script>
</body>
</html>
