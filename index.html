<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Control Aeropuerto — Sura</title>
<style>
  :root{
    --bg:#fff; --fg:#111; --muted:#666; --brand:#0b5fff;
    --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --line:#e5e7eb; --chip:#f3f4f6;
    --stickyPad: 0px;          /* <-- padding superior real del contenedor con scroll */
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:13.5px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:20}
  .wrap{max-width:1200px;margin:0 auto;padding:10px 14px}
  .title{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{background:var(--chip);border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px}
  .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  button{
    border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:13px
  }
  button:hover{border-color:var(--brand)}
  .btn-ghost{border:1px solid var(--line);background:#fff}
  .btn-danger{background:#fee2e2;border-color:#fecaca;color:#b91c1c}
  .btn-primary{background:var(--brand);color:#fff;border:1px solid var(--brand)}
  input[type="text"],input[type="date"],select{
    border:1px solid var(--line);padding:6px 8px;border-radius:10px;min-width:160px;font-size:13px
  }

  .note{color:var(--muted);padding:6px 14px;border-bottom:1px solid var(--line)}
  .table-wrap{
    overflow:auto;border-top:1px solid var(--line);
    /* TRUCO CLAVE: empuja el contenido para que el THEAD sticky quede justo abajo del header+nota */
    padding-top: var(--stickyPad);
  }
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{
    position:sticky; top:0;            /* <-- pega al tope del contenedor con scroll */
    background:#fff;border-bottom:1px solid var(--line);
    padding:6px 6px;text-align:left;white-space:nowrap;font-size:12px;color:var(--muted);z-index:10
  }
  tbody td{border-bottom:1px solid var(--line);padding:6px 6px;white-space:nowrap}
  tbody tr:hover{background:#fafafa}
  .center{text-align:center}
  .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 8px;font-weight:600;font-size:12px}
  .pill.green{background:#ecfdf5;color:var(--ok);border:1px solid #bbf7d0}
  .pill.yellow{background:#fffbeb;color:var(--warn);border:1px solid #fde68a}
  .pill.red{background:#fef2f2;color:var(--bad);border:1px solid #fecaca}
  .editable{background:#fffdf7;border:1px dashed #f5d48b;padding:4px 6px;border-radius:8px;width:180px;font-size:13px}

  /* FAB */
  .fab{position:fixed;right:16px;bottom:16px;z-index:30}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:center;justify-content:center;z-index:40}
  .modal.open{display:flex}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;max-width:980px;width:96%;padding:14px}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .grid label{font-size:12px;color:var(--muted)}
  .grid input,.grid select{width:100%}
  .row{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
  .hint{font-size:12px;color:var(--muted)}
  @media (max-width:1000px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">
      <h1 style="margin:0;font-size:24px;">Control Aeropuerto</h1>
      <span class="badge">Empresa: Sura</span>
      <span class="badge">Vuelo de Ida: AM 0668 · MEX–SFO · 08:55–11:55 · 03/11/2025</span>
      <span class="badge">Regreso: AM 0665 · SFO–MEX · 07/11/2025</span>
    </div>
    <div class="actions">
      <input id="search" type="text" placeholder="Buscar (nombre, apellidos, localizador...)"/>
      <select id="filtroSemaforo"><option value="">Semáforo (todos)</option><option value="verde">Verde</option><option value="amarillo">Amarillo</option><option value="rojo">Rojo</option></select>
      <select id="filtroAsistencia"><option value="">Asistencia (todos)</option><option value="Sí">Sí</option><option value="No">No</option></select>
      <select id="filtroMigracion"><option value="">Migración (todos)</option><option value="Sí">Sí</option><option value="No">No</option></select>
      <button id="btnExport">Exportar CSV</button>
      <button onclick="window.print()">Imprimir</button>
      <span class="hint" id="count"></span>
    </div>
  </div>
</header>

<div class="note wrap" id="note">
  Checklist activo: <strong>1) Asistencia</strong> · <strong>2) Migración</strong> · Campos editables: Pasaporte y Notas.
</div>

<div class="table-wrap wrap">
  <table id="grid">
    <thead>
      <tr>
        <th>#</th>
        <th>NOMBRE</th>
        <th>APELLIDO PATERNO</th>
        <th>APELLIDO MATERNO</th>
        <th>FECHA NAC.</th>
        <th>FECHA SALIDA</th>
        <th>VUELO IDA</th>
        <th>RUTA IDA</th>
        <th>HORA IDA</th>
        <th>FECHA REGRESO</th>
        <th>VUELO REGRESO</th>
        <th>RUTA REGRESO</th>
        <th>HORA REGRESO</th>
        <th>CLAVE</th>
        <th>PASAPORTE</th>
        <th class="center">ASIST.</th>
        <th class="center">MIGR.</th>
        <th>SEMÁFORO</th>
        <th>NOTAS</th>
        <th>ACCIONES</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Botón agregar -->
<div class="fab"><button class="btn-primary" id="btnAdd">➕ Agregar pasajero</button></div>

<!-- Modal agregar/editar -->
<div class="modal" id="modal">
  <div class="card">
    <h3 id="formTitle" style="margin:0 0 8px 0">Nuevo pasajero</h3>
    <div class="grid">
      <div><label>Nombre</label><input id="fNombre" type="text" required></div>
      <div><label>Apellido paterno</label><input id="fAp" type="text" required></div>
      <div><label>Apellido materno</label><input id="fAm" type="text"></div>
      <div><label>Fecha nacimiento</label><input id="fFn" type="date"></div>

      <div><label>Fecha salida</label><input id="fFs" type="text" placeholder="DD/MM/AAAA"></div>
      <div><label>Vuelo ida</label><input id="fVid" type="text" placeholder="AM 0668"></div>
      <div><label>Ruta ida</label><input id="fRid" type="text" placeholder="MEX-SFO"></div>
      <div><label>Hora ida</label><input id="fHid" type="text" placeholder="08:55-11:55"></div>

      <div><label>Fecha regreso</label><input id="fFr" type="text" placeholder="DD/MM/AAAA"></div>
      <div><label>Vuelo regreso</label><input id="fVr" type="text" placeholder="AM 0665"></div>
      <div><label>Ruta regreso</label><input id="fRr" type="text" placeholder="SFO-MEX"></div>
      <div><label>Hora regreso</label><input id="fHr" type="text" placeholder="22:52-05:15"></div>

      <div><label>Clave (localizador)</label><input id="fClave" type="text"></div>
      <div><label>Pasaporte</label><input id="fPasaporte" type="text"></div>
      <div><label>Asistencia</label><select id="fAsistencia"><option>No</option><option>Sí</option></select></div>
      <div><label>Migración</label><select id="fMigracion"><option>No</option><option>Sí</option></select></div>

      <div style="grid-column:1/5"><label>Notas</label><input id="fNotas" type="text"></div>
    </div>
    <div class="row">
      <button class="btn-ghost" id="fCancel">Cancelar</button>
      <button class="btn-primary" id="fSave">Guardar</button>
    </div>
  </div>
</div>

<script>
/* ========= Datos base ========= */
const BASE_FLIGHT={fs:"03/11/2025",vid:"AM 0668",rid:"MEX-SFO",hid:"08:55-11:55",fr:"07/11/2025",vr:"AM 0665",rr:"SFO-MEX",hr:"22:52-05:15"};

const base=[
 [1,"ADOLFO","ARDITTI","BEJARANO","1970-09-02",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"GZDOXH"],
 [2,"ALEJANDRO","MUZQUIZ","DIAZ","1972-04-13",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"],
 [3,"Anayeli Guadalupe","Rodríguez","Cardenas","1986-12-11",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG/UDSTQO"],
 [4,"Diana","Bernal","Chavez","1988-01-15",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"],
 [5,"Elizabeth","Ruiz","Domínguez","1984-10-08",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"],
 [6,"ELIZABETH BELEM","MUNGUÍA","LUGO","1975-03-01",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG/NFTUMS"],
 [7,"FRANCISCO OMAR","MURIANO","FLORES","1979-06-25",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"],
 [8,"Jannelle","Domínguez","Cruz","1979-06-25",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"],
 [9,"JULIETA","FLORES","HERNANDEZ","1974-07-30",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG/NFTUMS"],
 [10,"Luis Gerardo","Valdés","Manzano","1970-05-13",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"],
 [11,"María violeta","martinez","altamirano","1975-12-21",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"],
 [12,"MARIA CRISTINA","GONZÁLEZ","GUERRERO","1968-02-29",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG/HQIRXG"],
 [13,"MARIA Yolanda","TERREROS","PEREZ","1969-09-11",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"LKEUJT"],
 [14,"Nancy","Copca","Lopez","1969-09-11",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"],
 [15,"Ricardo","Angel","Sevilla","1978-05-29",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"],
 [16,"Ricardo","Benitez","Iturbide","1989-03-12",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"ICQOPR"],
 [17,"Ruth","Jacqueline","Garcia","1987-09-08",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"],
 [18,"SILVIA SOCORRO","RODRÍGUEZ","MOLINA","1978-08-23",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"],
 [19,"YAZMIN RAQUEL","PONCE","REYNOSO","",BASE_FLIGHT.fs,BASE_FLIGHT.vid,BASE_FLIGHT.rid,BASE_FLIGHT.hid,BASE_FLIGHT.fr,BASE_FLIGHT.vr,BASE_FLIGHT.rr,BASE_FLIGHT.hr,"HKHGVG"]
];

/* ========= Estado ========= */
const STORE_KEY="control_aeropuerto_sura_v5";
function loadState(){try{return JSON.parse(localStorage.getItem(STORE_KEY)||"{}")}catch{return{}}}
function saveState(){localStorage.setItem(STORE_KEY,JSON.stringify(state))}
let state=loadState();
// state = { checks:{no:{pasaporte,asistencia,migracion,notas}}, extras:[row...], overrides:{no:row}, deleted:{no:true} }
state.checks=state.checks||{};
state.extras=state.extras||[];
state.overrides=state.overrides||{};
state.deleted=state.deleted||{};

/* ========= Utilidades ========= */
function normalize(s){return String(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\p{L}\p{N}\s]/gu," ").replace(/\s+/g," ").trim()}
function matchesQuery(obj,q){if(!q)return true;const h=normalize([obj.nombre,obj.ap,obj.am,obj.clave,obj.vid,obj.rid,obj.vr,obj.rr].join(" "));return normalize(q).split(" ").every(t=>h.includes(t))}
function semaforo(a,m){if(a&&m)return["green","OK"];if(a||m)return["yellow","Faltante"];return["red","Pendiente"]}
function pill(color){const map={green:["green","✔"],yellow:["yellow","!"],red:["red","●"]};const [cls,icon]=map[color]||["red","●"];const label=cls==="green"?"VERDE":cls==="yellow"?"AMARILLO":"ROJO";return `<span class="pill ${cls}"><span>${icon}</span><span>${label}</span></span>`}
function listRows(){
  const byNo={};
  for(const r of base){byNo[r[0]]=r}
  for(const r of state.extras){byNo[r[0]]=r}
  for(const no of Object.keys(state.overrides)){byNo[+no]=state.overrides[no]}
  for(const no of Object.keys(state.deleted)){if(state.deleted[no]) delete byNo[+no]}
  return Object.values(byNo).sort((a,b)=>a[0]-b[0]);
}

/* ========= Render ========= */
const tbody=document.querySelector("#grid tbody");
function render(){
  const q=search.value, fS=filtroSemaforo.value, fA=filtroAsistencia.value, fM=filtroMigracion.value;
  tbody.innerHTML=""; let visibles=0;

  for(const r of listRows()){
    const [no,nombre,ap,am,fn,fs,vid,rid,hid,fr,vr,rr,hr,clave]=r;
    const st=state.checks[no]||{pasaporte:"",asistencia:false,migracion:false,notas:""};
    const obj={nombre,ap,am,clave,vid,rid,vr,rr};
    const [color]=semaforo(st.asistencia,st.migracion);

    if(!matchesQuery(obj,q)) continue;
    if(fS && !((fS==="verde"&&color==="green")||(fS==="amarillo"&&color==="yellow")||(fS==="rojo"&&color==="red"))) continue;
    if(fA && ((fA==="Sí")!==!!st.asistencia)) continue;
    if(fM && ((fM==="Sí")!==!!st.migracion)) continue;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${no}</td><td>${nombre}</td><td>${ap}</td><td>${am}</td><td>${fn||""}</td>
      <td>${fs}</td><td>${vid}</td><td>${rid}</td><td>${hid}</td>
      <td>${fr}</td><td>${vr}</td><td>${rr}</td><td>${hr}</td>
      <td>${clave}</td>
      <td><input class="editable" data-k="pasaporte" data-id="${no}" type="text" value="${st.pasaporte||""}" placeholder="N° pasaporte"></td>
      <td class="center"><input type="checkbox" data-k="asistencia" data-id="${no}" ${st.asistencia?"checked":""}></td>
      <td class="center"><input type="checkbox" data-k="migracion" data-id="${no}" ${st.migracion?"checked":""}></td>
      <td>${pill(color)}</td>
      <td><input class="editable" data-k="notas" data-id="${no}" type="text" value="${st.notas||""}" placeholder="Notas"></td>
      <td>
        <button class="btn-ghost" data-act="edit" data-id="${no}">Editar</button>
        <button class="btn-danger" data-act="del" data-id="${no}">Eliminar</button>
      </td>`;
    tbody.appendChild(tr); visibles++;
  }
  count.textContent=`${visibles} pasajer@/s mostrados`;
}

/* ========= Eventos celdas y filtros ========= */
document.addEventListener("input",(e)=>{
  const t=e.target;
  if(t.matches(".editable,[type=checkbox]")){
    const id=Number(t.dataset.id), k=t.dataset.k;
    state.checks[id]=state.checks[id]||{pasaporte:"",asistencia:false,migracion:false,notas:""};
    state.checks[id][k]=(t.type==="checkbox")?t.checked:t.value;
    saveState(); if(t.type==="checkbox") render();
  }
  if(t.id==="search") render();
});
["filtroSemaforo","filtroAsistencia","filtroMigracion"].forEach(id=>document.getElementById(id).addEventListener("change",render));

/* ========= Acciones Editar / Eliminar ========= */
document.addEventListener("click",(e)=>{
  const btn=e.target.closest("button"); if(!btn) return;
  const id=Number(btn.dataset.id);
  if(btn.dataset.act==="del"){
    if(!confirm("¿Eliminar este pasajero de la lista?")) return;
    const idx=state.extras.findIndex(r=>r[0]===id);
    if(idx>=0) state.extras.splice(idx,1); else state.deleted[id]=true;
    saveState(); render(); return;
  }
  if(btn.dataset.act==="edit"){ openForm("edit", id); }
});

/* ========= Export CSV ========= */
btnExport.addEventListener("click",()=>{
  const headers=["No","Nombre","Apellido Paterno","Apellido Materno","Fecha Nac","Fecha Salida","Vuelo Ida","Ruta Ida","Hora Ida","Fecha Regreso","Vuelo Regreso","Ruta Regreso","Hora Regreso","Clave","Pasaporte","Asistencia","Migración","Semáforo","Notas"];
  const lines=[headers.join(",")];
  for(const r of listRows()){
    const [no,nombre,ap,am,fn,fs,vid,rid,hid,fr,vr,rr,hr,clave]=r;
    const st=state.checks[no]||{};
    const [color]=semaforo(!!st.asistencia,!!st.migracion); const sem=color==="green"?"Verde":color==="yellow"?"Amarillo":"Rojo";
    const vals=[no,nombre,ap,am,fn||"",fs,vid,rid,hid,fr,vr,rr,hr,clave,st.pasaporte||"",st.asistencia?"Sí":"No",st.migracion?"Sí":"No",sem,st.notas||""];
    lines.push(vals.map(v=>`"${String(v).replaceAll('"','""')}"`).join(","));
  }
  const blob=new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="Control_Aeropuerto_Sura.csv"; a.click(); URL.revokeObjectURL(a.href);
});

/* ========= Sticky correcto: padding del contenedor ========= */
function updateStickyTop(){
  const header=document.querySelector("header");
  const note=document.getElementById("note");
  const pad=(header?.offsetHeight||0)+(note?.offsetHeight||0);
  document.documentElement.style.setProperty("--stickyPad", pad + "px");
}
window.addEventListener("load",()=>{updateStickyTop(); render();});
window.addEventListener("resize",updateStickyTop);

/* ========= Modal: Agregar / Editar ========= */
const modal=document.getElementById("modal");
function fillForm(values={}){
  fNombre.value=values.nombre||""; fAp.value=values.ap||""; fAm.value=values.am||""; fFn.value=values.fn||"";
  fFs.value=values.fs||BASE_FLIGHT.fs; fVid.value=values.vid||BASE_FLIGHT.vid; fRid.value=values.rid||BASE_FLIGHT.rid; fHid.value=values.hid||BASE_FLIGHT.hid;
  fFr.value=values.fr||BASE_FLIGHT.fr; fVr.value=values.vr||BASE_FLIGHT.vr; fRr.value=values.rr||BASE_FLIGHT.rr; fHr.value=values.hr||BASE_FLIGHT.hr;
  fClave.value=values.clave||""; fPasaporte.value=values.pasaporte||""; fAsistencia.value=values.asistencia?"Sí":"No"; fMigracion.value=values.migracion?"Sí":"No"; fNotas.value=values.notas||"";
}
let formMode="add"; let editingId=null;
function openForm(mode="add", id=null){
  formMode=mode; editingId=id;
  if(mode==="add"){ formTitle.textContent="Nuevo pasajero"; fillForm({}); }
  else{
    formTitle.textContent="Editar pasajero";
    const r=listRows().find(x=>x[0]===id), st=state.checks[id]||{};
    const [no,nombre,ap,am,fn,fs,vid,rid,hid,fr,vr,rr,hr,clave]=r;
    fillForm({nombre,ap,am,fn,fs,vid,rid,hid,fr,vr,rr,hr,clave,pasaporte:st.pasaporte,asistencia:st.asistencia,migracion:st.migracion,notas:st.notas});
  }
  modal.classList.add("open");
}
btnAdd.addEventListener("click",()=>openForm("add"));
fCancel.addEventListener("click",()=>modal.classList.remove("open"));
fSave.addEventListener("click",()=>{
  const nombre=fNombre.value.trim(), ap=fAp.value.trim();
  if(!nombre||!ap){alert("Nombre y Apellido paterno son obligatorios.");return;}
  const am=fAm.value.trim(), fn=fFn.value, fs=fFs.value.trim(), vid=fVid.value.trim(), rid=fRid.value.trim(), hid=fHid.value.trim(),
        fr=fFr.value.trim(), vr=fVr.value.trim(), rr=fRr.value.trim(), hr=fHr.value.trim(), clave=fClave.value.trim()||"—",
        pas=fPasaporte.value.trim(), asis=fAsistencia.value==="Sí", migr=fMigracion.value==="Sí", notas=fNotas.value.trim();

  if(formMode==="add"){
    const maxNo=Math.max(...listRows().map(r=>Number(r[0])),0);
    const no=maxNo+1;
    const newRow=[no,nombre,ap,am,fn,fs,vid,rid,hid,fr,vr,rr,hr,clave];
    state.extras.push(newRow);
    state.checks[no]={pasaporte:pas,asistencia:asis,migracion:migr,notas};
  }else{
    const no=editingId;
    state.overrides[no]=[no,nombre,ap,am,fn,fs,vid,rid,hid,fr,vr,rr,hr,clave];
    state.checks[no]={pasaporte:pas,asistencia:asis,migracion:migr,notas};
  }
  saveState(); modal.classList.remove("open"); render();
});
</script>
</body>
</html>
